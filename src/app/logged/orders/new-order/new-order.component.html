<mat-horizontal-stepper [linear]="true" (selectionChange)="onTabChange($event)" class="card-shadow"
   labelPosition="bottom">
   <!-- Step 1 -->
   <mat-step [completed]="this.formConfiguration && this.getFiles().controls.length > 0" label="Seleccionar archivos">
      <mat-tab-group class="mb-4" fxFlex="100" [color]="'accent'" mat-align-tabs="center">
         <mat-tab label="Buscar archivo">
            <div class="my-3">
               <div *ngIf="!this.previousQuestionRing && this.formConfiguration.disabled" fxFlex="100">
                  <button (click)="editAfterRing()" mat-stroked-button [color]="'primary'">
                     <mat-icon class="mat-18">edit</mat-icon>Editar
                  </button>
                  <span class="text-secondary ml-3">(Se reseteará la configuración del anillado)</span>
               </div>
               <span *ngIf="!this.formConfiguration || (this.formConfiguration && this.getFiles().controls.length < 1)"
                  class="text-warn">Debe seleccionar al menos un archivo para continuar</span>
               <span *ngIf="this.formConfiguration && this.getFiles().controls.length > 0" class="text-primary">Archivos
                  seleccionados: {{ this.getFiles().controls.length }}</span>
            </div>
            <!-- Buscar archivo -->
            <mat-tree [dataSource]="dataSource" [treeControl]="treeControl" class="example-tree">
               <!-- This is the tree node template for leaf nodes -->
               <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle>
                  <li class="mat-tree-node">
                     <mat-checkbox [disabled]="!this.previousQuestionRing" (change)="handlerAddFile($event, node)"
                        class="ml-2 checklist-leaf-node">
                        {{ node.name }}
                     </mat-checkbox>
                     <button mat-icon-button class="ml-2" (click)="downloadFile(node)">
                        <mat-icon>cloud_download</mat-icon>
                     </button>
                  </li>
               </mat-tree-node>
               <!-- This is the tree node template for expandable nodes -->
               <mat-nested-tree-node *matTreeNodeDef="let node; when: hasChild">
                  <li>
                     <div class="mat-tree-node">
                        <button mat-icon-button matTreeNodeToggle [attr.aria-label]="'toggle ' + node.name">
                           <mat-icon class="mat-icon-rtl-mirror">
                              {{ treeControl.isExpanded(node) ? "expand_more" : "chevron_right" }}
                           </mat-icon>
                           {{ node.name }}
                        </button>
                     </div>
                     <ul [class.example-tree-invisible]="!treeControl.isExpanded(node)">
                        <ng-container matTreeNodeOutlet></ng-container>
                     </ul>
                  </li>
               </mat-nested-tree-node>
            </mat-tree>
         </mat-tab>
         <mat-tab label="Subir archivo">
            <!-- Subir archivo -->
            Content 2
         </mat-tab>
      </mat-tab-group>
      <div>
         <button mat-raised-button matStepperNext>Siguiente</button>
      </div>
   </mat-step>
   <!-- Step 2 -->
   <mat-step [stepControl]="this.formConfiguration" label="Configurar archivos">
      <div fxLayout="row wrap" fxLayoutAlign="start center" fxFlex="100">
         <div *ngIf="!this.previousQuestionRing && this.formConfiguration.disabled" fxFlex="100">
            <button (click)="editAfterRing()" mat-stroked-button [color]="'primary'">
               <mat-icon class="mat-18">edit</mat-icon>Editar
            </button>
            <span class="text-secondary ml-3">(Se reseteará la configuración del anillado)</span>
         </div>
         <form *ngIf="this.formConfiguration" [formGroup]="this.formConfiguration" fxFlex="100">
            <mat-accordion class="card-shadow my-1" fxFlex="100%">
               <mat-expansion-panel [formArrayName]="this.FORM_CONFIGURATION_VALUES.filesName" *ngFor="
                     let file of this.formConfiguration.get(this.FORM_CONFIGURATION_VALUES.filesName)['controls'];
                     let i = index
                  ">
                  <mat-expansion-panel-header>
                     <mat-panel-title fxLayoutAlign="center start">
                        <h4 class="text-center mt-3" fxLayoutAlign="center start" fxFlex="40">
                           <!-- {{ archivo.name}} ({{this.calcularPrecioArchivo(i) | moneda}}) -->
                           <div class="mr-3">
                              <span *ngIf="
                                    this.getFiles().controls[i].status == 'VALID' ||
                                    this.getFiles().controls[i].disabled
                                 ">
                                 <mat-icon [color]="'primary'">check_circle</mat-icon>
                              </span>
                              <span *ngIf="this.getFiles().controls[i].status == 'INVALID'">
                                 <mat-icon [color]="'warn'">error</mat-icon>
                              </span>
                           </div>
                           {{
                              file.value[this.FORM_CONFIGURATION_VALUES.files.name] +
                                 " (" +
                                 file.value[this.FORM_CONFIGURATION_VALUES.files.courseName] +
                                 ")"
                           }}
                        </h4>
                     </mat-panel-title>
                  </mat-expansion-panel-header>
                  <div [formGroupName]="i" class="my-3">
                     <!-- Configuracion del archivo -->
                     <div fxLayout="column wrap">
                        <div class="separator separator-center-left mb-1">
                           <span class="mx-2 text-secondary">Configuración General</span>
                        </div>
                        <!-- Row 1 -->
                        <div fxLayout="row wrap" fxLayoutGap="5%">
                           <mat-form-field fxFlex="25%">
                              <input min="1" max="10"
                                 [formControlName]="this.FORM_CONFIGURATION_VALUES.files.copiesQuantity" required
                                 (change)="onChangeCantidad(i)" matInput ngkey (keydown)="onKeyDown()" type="number" />
                              <mat-error>Ingrese la cantidad de copias</mat-error>
                              <mat-label>
                                 <b>Cantidad de copias</b>
                              </mat-label>
                           </mat-form-field>
                           <div fxLayoutAlign="center center">
                              <mat-checkbox [formControlName]="this.FORM_CONFIGURATION_VALUES.files.sameConfig"
                                 (change)="onChangeCopiasMismaConfig(i)">
                                 Todas las copias tienen la misma configuración
                              </mat-checkbox>
                           </div>
                        </div>

                        <div fxLayout="column wrap"
                           [formArrayName]="this.FORM_CONFIGURATION_VALUES.files.configurationsName" *ngFor="
                              let configuration of file.controls[
                                 this.FORM_CONFIGURATION_VALUES.files.configurationsName
                              ].controls;
                              let z = index
                           ">
                           <div [formGroupName]="z">
                              <div *ngIf="
                                    file.value[this.FORM_CONFIGURATION_VALUES.files.sameConfig];
                                    else textoConfiguracionIndiviual
                                 ">
                                 <!-- <h3>
                                    Configuracion de las copias
                                 </h3> -->
                                 <div class="separator separator-center-left my-3">
                                    <span class="mx-2 text-secondary">Configuración de las copias</span>
                                 </div>
                              </div>
                              <ng-template #textoConfiguracionIndiviual>
                                 <div class="separator separator-center-left my-3">
                                    <span class="mx-2 text-secondary">Configuracion de la copia #{{ z + 1 }}</span>
                                 </div>
                              </ng-template>
                              <div fxLayout="row wrap" class="mb-3">
                                 <div fxFlex="25%">
                                    <mat-form-field [hideRequiredMarker]="true" [floatLabel]="'auto'">
                                       <mat-select [compareWith]="compareFn" [formControlName]="
                                             this.FORM_CONFIGURATION_VALUES.files.configurations.slidesPerSheet
                                          ">
                                          <mat-option value="{{ opcion.value }}"
                                             *ngFor="let opcion of opcionesDiapHoja">
                                             {{ opcion.value }}
                                          </mat-option>
                                       </mat-select>
                                       <mat-label>
                                          <b> Diapositivas por hoja</b>
                                       </mat-label>
                                    </mat-form-field>
                                 </div>
                                 <div fxFlex="25%">
                                    <mat-form-field>
                                       <mat-select (valueChange)="onChangeSelectedSheets($event, configuration)"
                                          [formControlName]="
                                             this.FORM_CONFIGURATION_VALUES.files.configurations.selectedSheets
                                          " [compareWith]="compareFn">
                                          <mat-option value="0">
                                             Todas
                                          </mat-option>
                                          <mat-option value="1">
                                             Personalizado
                                          </mat-option>
                                       </mat-select>
                                       <mat-label>
                                          <b>Páginas</b>
                                       </mat-label>
                                       <mat-hint>
                                          El archivo contiene
                                          <b>{{
                                                file.value[this.FORM_CONFIGURATION_VALUES.files.pagesQuantity]
                                             }}
                                             páginas</b></mat-hint>
                                    </mat-form-field>
                                    <mat-form-field class="mt-5" (change)="mostrar($event)" *ngIf="
                                          configuration.value[
                                             this.FORM_CONFIGURATION_VALUES.files.configurations.selectedSheets
                                          ] == 1
                                       " [floatLabel]="'auto'">
                                       <input [errorStateMatcher]="matcher" pattern="\d+(?:-\d+)?(?:,\d+(?:-\d+)?)*"
                                          matInput type="text" [formControlName]="
                                             this.FORM_CONFIGURATION_VALUES.files.configurations.fromToInput
                                          " />
                                       <mat-label>
                                          <b> Desde-Hasta</b>
                                       </mat-label>
                                       <mat-error *ngIf="configuration.errors?.fromToInput">Requerido </mat-error>
                                       <mat-error *ngIf="!!configuration.controls.desdehastainput.errors?.pattern">Rango
                                          de páginas no válido, utiliza p. ej. 1-5, 8, 11-13
                                       </mat-error>
                                       <mat-error *ngIf="
                                             !configuration.controls.desdehastainput.errors?.pattern &&
                                             configuration.errors?.length
                                          ">Rango de máximo superado
                                       </mat-error>
                                       <mat-hint> <b>p. ej. 1-5, 8, 11-13</b></mat-hint>
                                    </mat-form-field>
                                 </div>
                                 <div fxLayoutAlign="start start" fxFlex="20%">
                                    <div fxLayout="column">
                                       <mat-checkbox
                                          [formControlName]="this.FORM_CONFIGURATION_VALUES.files.configurations.duplex">
                                          Doble faz
                                       </mat-checkbox>
                                       <mat-checkbox [disabled]="true"
                                          [formControlName]="this.FORM_CONFIGURATION_VALUES.files.configurations.colour">
                                          Color
                                       </mat-checkbox>
                                    </div>
                                 </div>
                                 <div fxFlex="17%" fxLayoutAlign="start start" class="mt-2">
                                    <span class="text-secondary">
                                       {{
                                          !this.getFiles().value[i][
                                             this.FORM_CONFIGURATION_VALUES.files.configurationsName
                                          ][z][this.FORM_CONFIGURATION_VALUES.files.configurations.idRingerGroup]
                                             ? "Sin anillar"
                                             : "Anillado " +
                                               this.getFiles().value[i][
                                                  this.FORM_CONFIGURATION_VALUES.files.configurationsName
                                               ][z][this.FORM_CONFIGURATION_VALUES.files.configurations.idRingerGroup] +
                                               " (" +
                                               this.getFiles().value[i][
                                                  this.FORM_CONFIGURATION_VALUES.files.configurationsName
                                               ][z][this.FORM_CONFIGURATION_VALUES.files.configurations.ringedOrder] +
                                               "°)"
                                       }}
                                    </span>
                                 </div>
                                 <div fxLayoutAlign="start center" fxFlex="12%"></div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </mat-expansion-panel>
            </mat-accordion>
         </form>
      </div>
      <div>
         <button mat-button matStepperPrevious>Atrás</button>
         <button mat-raised-button matStepperNext>Siguiente</button>
      </div>
   </mat-step>
   <!-- Step 3 -->
   <mat-step [stepControl]="this.formConfiguration" label="Configurar anillados">
      <div fxLayout="column wrap">
         <div *ngIf="previousQuestionRing">
            <div fxLayoutAlign="center stretch" class="text-secondary">
               <h3>¿Deseas anillar algún archivo?</h3>
            </div>
            <div fxLayout="row wrap" fxLayoutAlign="center stretch" fxLayoutGap="4%">
               <button mat-raised-button matStepperNext>No</button>
               <button mat-raised-button [color]="'primary'" (click)="onClickAcceptRing()">Sí</button>
            </div>
         </div>
         <div *ngIf="!previousQuestionRing" fxLayout="row" fxLayoutAlign="space-between stretch">
            <mat-card *ngIf="!!this.formConfiguration" fxFlex="45" class="card-shadow">
               <mat-card-content fxLayout="column">
                  <!-- Title -->
                  <div fxFlex="100" class="separator separator-center-left" style="margin-top: 75px;">
                     <span class="mx-2 text-secondary">
                        Listado de archivos
                     </span>
                  </div>
                  <!-- List -->
                  <mat-list dense>
                     <div *ngFor="let archivo of this.formConfiguration.value.archivos; let j = index">
                        <mat-list-item *ngFor="let configuracion of archivo.configuraciones; let i = index">
                           <span fxFlex="60">
                              {{
                                 "- " + archivo.name + (archivo.configuraciones.length > 1 ? " (" + (i + 1) + ")" : "")
                              }}
                              {{ " (" + archivo[this.FORM_CONFIGURATION_VALUES.files.courseName] + ")" }}
                           </span>
                           <div fxFlex="40" fxLayoutAlign="center stretch">
                              <button [disabled]="!configuracion.id_grupo_anillado ? null : true" mat-icon-button
                                 (click)="onRingFile(archivo, j, i)"
                                 [matTooltip]="'Anillar el archivo ' + archivo.name">
                                 <mat-icon [ngClass]="{
                                       'text-primary': !configuracion.id_grupo_anillado,
                                       'text-secondary': !!configuracion.id_grupo_anillado
                                    }">send</mat-icon>
                              </button>
                           </div>
                        </mat-list-item>
                     </div>
                  </mat-list>
               </mat-card-content>
            </mat-card>
            <mat-card *ngIf="!!this.formConfiguration" fxFlex="45" class="card-shadow">
               <mat-card-content fxLayout="column">
                  <div fxLayoutAlign="space-between center">
                     <span>
                        {{
                           this.tabs[this.tabAnillados.selectedIndex].ringType
                              ? this.tabs[this.tabAnillados.selectedIndex].ringType.name
                              : "Sin anillado"
                        }}</span>
                     <div>
                        <button mat-icon-button [disabled]="isDisabledNewTabAnillado()" (click)="onAddTabAnillado(true)"
                           matTooltip="Crear nuevo grupo de anillado">
                           <mat-icon [ngClass]="{
                                 'text-primary': !isDisabledNewTabAnillado(),
                                 'text-secondary': isDisabledNewTabAnillado()
                              }">add_circle</mat-icon>
                        </button>
                        <button mat-icon-button [disabled]="tabs.length === 1"
                           (click)="onRemoveTabAnillado(this.tabAnillados.selectedIndex)"
                           matTooltip="Eliminar el grupo de anillado">
                           <mat-icon [ngClass]="{
                                 'text-warn': tabs.length !== 1,
                                 'text-secondary': tabs.length === 1
                              }">delete</mat-icon>
                        </button>
                     </div>
                  </div>

                  <mat-tab-group #tabAnillados [selectedIndex]="selected.value"
                     (selectedIndexChange)="selected.setValue($event)">
                     <mat-tab *ngFor="let tab of tabs; let index = index" [label]="'Anillado' + ' ' + (index + 1)">
                        <mat-list dense>
                           <div fxLayoutAlign="center stretch" *ngIf="tab.files.length === 0">
                              <span class=" mt-1 text-secondary">
                                 Anillado vacío
                              </span>
                           </div>
                           <mat-list-item class="mt-1" *ngFor="let file of tab.files; let indexFile = index">
                              <button mat-icon-button (click)="
                                    this.onRemoveRingFile(file.indexArchivo, file.indexConfiguracion, index, indexFile)
                                 " [matTooltip]="'Quitar ' + file.name + ' del anillado'">
                                 <mat-icon style="transform: rotate(180deg)" [color]="'warn'">cancel_schedule_send
                                 </mat-icon>
                              </button>
                              <div fxFlex="100" fxLayoutAlign="space-between stretch">
                                 <span>
                                    {{
                                       file.name +
                                          (this.formConfiguration.value["archivos"][file.indexArchivo][
                                             "configuraciones"
                                          ].length > 1
                                             ? " (" + (file.indexConfiguracion + 1) + ")"
                                             : "")
                                    }}
                                    {{ " (" + file.course + ")" }}
                                 </span>
                                 <span class="text-secondary-darker" [matTooltip]="
                                       file.name + ' ocupará la ' + (indexFile + 1) + '° posición del anillado'
                                    ">
                                    <b>
                                       {{ indexFile + 1 + "° " }}
                                    </b>
                                 </span>
                              </div>
                           </mat-list-item>
                        </mat-list>
                     </mat-tab>
                  </mat-tab-group>
               </mat-card-content>
            </mat-card>
         </div>
      </div>
      <div class="mt-3">
         <button mat-button matStepperPrevious>Atrás</button>
         <button mat-raised-button matStepperNext>Siguiente</button>
      </div>
   </mat-step>
   <!-- Step 4 -->
   <mat-step label="Finalizar pedido" fxLayout="row">
      <!-- </form> -->
      <div fxLayout="row wrap">
         <div fxFlex="100%">
            <mat-form-field fxFlex="100%">
               <mat-select [(ngModel)]="id_sede" (valueChange)="onSelectedSede($event)">
                  <mat-option value="{{ sede.id }}" *ngFor="let sede of sedes">
                     {{ sede.name }}
                  </mat-option>
               </mat-select>
               <mat-label>
                  <b> Seleccione la sede en donde lo retirará</b>
               </mat-label>
            </mat-form-field>
         </div>
      </div>
      <!-- Tabla de detalles del pedido -->
      <div class="my-4" fxLayout="row wrap">
         <div fxFlex="100%">
            <table fxFlex="100%" *ngIf="mostrarTabla" mat-table [dataSource]="this.tableTemplate"
               class="mat-elevation-z8">
               <!-- Archivo Column -->
               <ng-container matColumnDef="Archivo">
                  <th mat-header-cell *matHeaderCellDef>Archivo</th>
                  <td mat-cell *matCellDef="let archivo">
                     {{ archivo.archivo }}
                     {{ archivo.materia ? " (" + archivo.materia + ")" : "" }}
                  </td>
                  <td mat-footer-cell *matFooterCellDef><b>Total</b></td>
               </ng-container>

               <!-- Cantidad Column -->
               <ng-container matColumnDef="CarillasTotales">
                  <th mat-header-cell *matHeaderCellDef>Carillas Totales</th>
                  <td mat-cell *matCellDef="let archivo">{{ archivo.carillasTotales }}</td>
                  <td mat-footer-cell *matFooterCellDef></td>
               </ng-container>

               <!-- Paginas totales Column -->
               <ng-container matColumnDef="Cantidad">
                  <th mat-header-cell *matHeaderCellDef>Cantidad</th>
                  <td mat-cell *matCellDef="let archivo">{{ archivo.cantidad }}</td>
                  <td mat-footer-cell *matFooterCellDef></td>
               </ng-container>

               <!-- Precio Column -->
               <ng-container matColumnDef="Precio">
                  <th mat-header-cell *matHeaderCellDef>Precio</th>
                  <td mat-cell *matCellDef="let archivo">{{ archivo.precio | moneda }}</td>
                  <td mat-footer-cell *matFooterCellDef>
                     <b>{{ this.form.controls[this.FORM_CONFIGURATION_VALUES.totalPrice].value | moneda }}</b>
                  </td>
               </ng-container>

               <!-- Disclaimer column -->
               <ng-container matColumnDef="disclaimer">
                  <td mat-footer-cell *matFooterCellDef colspan="2">
                     <span *ngIf="this.form.valid" class="accent">
                        Verifique los datos del pedido y luego presione finalizar.
                     </span>
                     <span *ngIf="!this.form.get('id_sede').valid" class="warn">
                        Por favor, seleccione en la parte superior la sede donde lo retirará
                     </span>
                     <span *ngIf="!this.form.valid && this.form.get('id_sede').valid" class="warn">
                        Por favor, verifique los errores de configuración del paso 2
                     </span>
                  </td>
               </ng-container>

               <!-- The table will render two header rows, one data row per data object, and two footer rows. -->
               <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
               <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
               <tr mat-footer-row *matFooterRowDef="displayedColumns" class="example-first-footer-row"></tr>
               <tr mat-footer-row *matFooterRowDef="['disclaimer']" class="example-second-footer-row"></tr>
            </table>
         </div>
      </div>

      <button mat-button matStepperPrevious>Atrás</button>
      <button mat-raised-button [color]="'primary'" [disabled]="!this.form || !this.form.valid"
         (click)="onPostPedido()">
         Finalizar
      </button>
   </mat-step>

   <!-- Icon overrides. -->
   <ng-template matStepperIcon="phone">
      <mat-icon>call_end</mat-icon>
   </ng-template>
   <ng-template matStepperIcon="chat">
      <mat-icon>forum</mat-icon>
   </ng-template>
</mat-horizontal-stepper>

<cei-alert-error #alertError></cei-alert-error>
<swal #orderSuccessSwal title="Pedido solicitado correctamente"
   text="Podés realizar el seguimiento de su estado en 'Mis pedidos'" icon="success" [confirmButtonText]="'Genial!'"
   (confirm)="this.router.navigate([routes.LOGIN])">
</swal>

<swal #ringExceededSwal title="No es posible anillar el documento"
   text="El documento a anillar excede la máxima cantidad de hojas del grupo de anillado" icon="error"
   [confirmButtonText]="'Ok'">
</swal>